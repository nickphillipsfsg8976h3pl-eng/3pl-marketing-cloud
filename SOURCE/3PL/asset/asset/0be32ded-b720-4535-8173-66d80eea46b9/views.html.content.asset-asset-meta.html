%%[
/* Get all form fields value */
  SET @firstName = TRIM(RequestParameter("first-name"))
  SET @LastName = TRIM(RequestParameter("last-name"))
  SET @accesspass = RequestParameter("access_pass")
  SET @email = TRIM(RequestParameter("email"))
  SET @jobTitle = RequestParameter("job-title")
  SET @SubscriberKey = SHA256('@email','UTF-8')
SET @Campaign = Requestparameter('cid')

SET @Redirect = RequestParameter('rid')
SET @Product = RequestParameter('Product')
   SET @UTMcontent = RequestParameter("UTMcontent")
   SET @UTMcampaign = RequestParameter("utmcampaign")
   SET @UTMmedium = RequestParameter("utmmedium")
   SET @UTMsource = RequestParameter("utmsource")
   SET @UTMterm = RequestParameter("utmterm")
   SET @isReceiveEmail = RequestParameter("sub-opt-in")
   SET @enquiry = RequestParameter("eid")
   SET @pid = RequestParameter("pid")
   SET @localDate = Now()
   SET @updatedDate_start  = SystemDateToLocalDate(@localDate)
   SET @isReceiveEmail = RequestParameter("sub-opt-in")
   SET @isTermAgree = RequestParameter("tc-agree")



IF @pid == "Mathletics" THEN
   SET @updatedDate_end = DateAdd(@updatedDate_start, 30, "D")
   SET @Email_Lookup = Lookup('TriggeredSendDe_Auto-Trial_Mathletics','EmailAddress','EmailAddress',@email)
   SET @Subscriber_Lookup = Lookup('TriggeredSendDe_Auto-Trial_Mathletics','SubscriberKey','SubscriberKey',@SubscriberKey)
   SET @Confirmed_Lookup = Lookup('TriggeredSendDe_Auto-Trial_Mathletics','Confirmed','EmailAddress',@email)


IF @Subscriber_Lookup != @Email_Lookup AND @Confirmed_Lookup == "True" THEN
  REDIRECT("https://www.mathletics.com/for-schools/free-trial/access-your-login/")
ENDIF

ELSEIF @pid == "Readiwriter" THEN
   SET @updatedDate_end = DateAdd(@updatedDate_start, 30, "D")
   SET @Email_Lookup = Lookup('TriggeredSendDe_Auto-Trial_Readiwriter','EmailAddress','EmailAddress',@email)
   SET @Subscriber_Lookup = Lookup('TriggeredSendDe_Auto-Trial_Readiwriter','SubscriberKey','SubscriberKey',@SubscriberKey)
   SET @Confirmed_Lookup = Lookup('TriggeredSendDe_Auto-Trial_Readiwriter','Confirmed','EmailAddress',@email)


IF @Subscriber_Lookup != @Email_Lookup AND @Confirmed_Lookup == "True" THEN
  REDIRECT("https://www.3plearning.com/software/readiwriter/free-trial/access-your-login/")
ENDIF
ENDIF

  IF @isTermAgree == "agree" THEN
    SET @isTermAgree = "true"
  ELSE 
    SET @isTermAgree = "false"
  ENDIF

  IF @isReceiveEmail == "receive" THEN
    SET @isReceiveEmail = "true"
  ELSE 
    SET @isReceiveEmail = "false"
  ENDIF

/* Trigger Send External Key Selection */
IF @pid == "Mathletics" THEN
SET @TID = "83067" 
ELSE
SET @TID = "83520"
ENDIF


/* Trigger Send Object Creation */
            SET @ts = CreateObject("TriggeredSend")
            SET @tsDef = CreateObject("TriggeredSendDefinition")
            SET @ts_subkey = @email

/* Set the External Key of the Trigger Send Definition */
            SetObjectProperty(@tsDef, "CustomerKey", @TID)
            SetObjectProperty(@ts, "TriggeredSendDefinition", @tsDef)

/* Create the Subscriber Object */
            SET @ts_sub = CreateObject("Subscriber")
            SetObjectProperty(@ts_sub, "EmailAddress", @email)


/* Set SubscriberKey to EmailAddress */
            SetObjectProperty(@ts_sub, "SubscriberKey", @ts_subkey)


/* Create and Set Attributes */
            SET @attr = CreateObject("Attribute")
            SetObjectProperty(@attr, "Name", "SubscriberKey")
            SetObjectProperty(@attr, "Value",  @ts_subkey)
            AddObjectArrayItem(@ts_sub, "Attributes", @attr)

            SET @attr = CreateObject("Attribute")
            SetObjectProperty(@attr, "Name", "EmailAddress")
            SetObjectProperty(@attr, "Value", @email)
            AddObjectArrayItem(@ts_sub, "Attributes", @attr)

            SET @attr = CreateObject("Attribute")
            SetObjectProperty(@attr, "Name", "FirstName")
            SetObjectProperty(@attr, "Value", @firstName)
            AddObjectArrayItem(@ts_sub, "Attributes", @attr)

            SET @attr = CreateObject("Attribute")
            SetObjectProperty(@attr, "Name", "LastName")
            SetObjectProperty(@attr, "Value", @LastName)
            AddObjectArrayItem(@ts_sub, "Attributes", @attr)

            SET @attr = CreateObject("Attribute")
            SetObjectProperty(@attr, "Name", "utm_content")
            SetObjectProperty(@attr, "Value", @accesspass)
            AddObjectArrayItem(@ts_sub, "Attributes", @attr)

            SET @attr = CreateObject("Attribute")
            SetObjectProperty(@attr, "Name", "Date_start")
            SetObjectProperty(@attr, "Value", @updatedDate_start)
            AddObjectArrayItem(@ts_sub, "Attributes", @attr)
            SET @attr = CreateObject("Attribute")

            SetObjectProperty(@attr, "Name", "Date_end")
            SetObjectProperty(@attr, "Value", @updatedDate_end)
            AddObjectArrayItem(@ts_sub, "Attributes", @attr)

            SET @attr = CreateObject("Attribute")
            SetObjectProperty(@attr, "Name", "Product")
            SetObjectProperty(@attr, "Value", @pid)
            AddObjectArrayItem(@ts_sub, "Attributes", @attr)

            SET @attr = CreateObject("Attribute")
            SetObjectProperty(@attr, "Name", "Date_Diff")
            SetObjectProperty(@attr, "Value", @Date_Diff)
            AddObjectArrayItem(@ts_sub, "Attributes", @attr)

            SET @attr = CreateObject("Attribute")
            SetObjectProperty(@attr, "Name", "job-title")
            SetObjectProperty(@attr, "Value", @jobTitle)
            AddObjectArrayItem(@ts_sub, "Attributes", @attr)

            SET @attr = CreateObject("Attribute")
            SetObjectProperty(@attr, "Name", "isReceiveEmail")
            SetObjectProperty(@attr, "Value", @isReceiveEmail)
            AddObjectArrayItem(@ts_sub, "Attributes", @attr)

            SET @attr = CreateObject("Attribute")
            SetObjectProperty(@attr, "Name", "cid")
            SetObjectProperty(@attr, "Value", @Campaign)
            AddObjectArrayItem(@ts_sub, "Attributes", @attr)


            SET @attr = CreateObject("Attribute")
            SetObjectProperty(@attr, "Name", "utm_campaign")
            SetObjectProperty(@attr, "Value", @UTMcampaign)
            AddObjectArrayItem(@ts_sub, "Attributes", @attr)

            SET @attr = CreateObject("Attribute")
            SetObjectProperty(@attr, "Name", "utm_medium")
            SetObjectProperty(@attr, "Value", @UTMmedium)
            AddObjectArrayItem(@ts_sub, "Attributes", @attr)

            SET @attr = CreateObject("Attribute")
            SetObjectProperty(@attr, "Name", "utm_source")
            SetObjectProperty(@attr, "Value", @UTMsource)
            AddObjectArrayItem(@ts_sub, "Attributes", @attr)

            SET @attr = CreateObject("Attribute")
            SetObjectProperty(@attr, "Name", "utm_term")
            SetObjectProperty(@attr, "Value", @UTMterm)
            AddObjectArrayItem(@ts_sub, "Attributes", @attr)

            
/* Add all Attributes into Array */
            AddObjectArrayItem(@ts, "Subscribers", @ts_sub)

/*Complete the Web API call to trigger send */
            SET @ts_statusCode = InvokeCreate(@ts, @ts_statusMsg, @errorCode)

/* Raise Error if Trigger fails */
            IF @ts_statusCode != "OK" THEN
               RaiseError(@ts_statusMsg, 0, @ts_statusCode, @errorCode)
            ENDIF 

/* Job Title redirect function */
            If @jobTitle == 'Parent' OR 'Home schooling parent' THEN
            SET @customerType = 'Home' 
            ELSE
            SET @customerType = 'School' 
            ENDIF         

/* Redirect if member already has an active trial */

IF @pid == 'Mathletics' OR 'mathletics' THEN
           REDIRECT("https://www.mathletics.com/for-schools/free-trial/verify-email")
           ELSEIF @pid == 'Readiwriter' OR 'readiwriter' THEN
           REDIRECT("https://www.3plearning.com/software/readiwriter/free-trial/verify-email/")

ENDIF

]%%