<!--
/*****************************************
-- UPDATE PREFRENCES v2
*****************************************/
-->


%%[/*

Welcome to the accompanying 'submit script' for the preference centre.

This script is used to take in the form data posted from the preference centre form, and update the following:

1. Markeing Cloud Profile & Preference Attributes
2. Marketing Cloud Publication List*
3. Salesforce CRM Marketing/Product Interests**


*NB: publication list updated only if product/marketing interest have actually changed
**NB: the CRM is not updated unless the list of subscribers submitted have a recognized Contact or Lead ID (beginning with 003 or 00Q respectively)

*/]%%


<script runat="server">
  Platform.Load("Core", "1")


  /*************************************
   GET REQUEST FIELDS
  *************************************/

  var params = {}


  //var job_id = Request.GetFormField("job_id");
  //var list_id = Request.GetFormField("list_id");
  //var batch_id = Request.GetFormField("batch_id");


  //Hidden
  params.subscriber_key = Request.GetFormField("subscriber_key");
  params.subscriber_keys = Request.GetFormField("subscriber_keys").split(',');
  params.email_address = Request.GetFormField("email_address");

  params.previous_mobile_number = Request.GetFormField("previous_mobile_number");
  params.previous_birthdate = Request.GetFormField("previous_birthdate");

  params.previous_product_information =  Request.GetFormField("previous_product_information")? true: false;
  params.previous_newsletter =  Request.GetFormField("previous_newsletter")? true: false;
  params.previous_promotions =  Request.GetFormField("previous_promotions")? true: false;
  params.previous_mathletics =  Request.GetFormField("previous_mathletics")? true: false;
  params.previous_mathseeds =  Request.GetFormField("previous_mathseeds")? true: false;
  params.previous_reading_eggs =  Request.GetFormField("previous_reading_eggs")? true: false;
  params.previous_status =  Request.GetFormField("previous_status")? true: false;


  //Form
  params.next_mobile_number =  Request.GetFormField("next_mobile_number");
  params.next_birthdate =  Request.GetFormField("next_birthdate");

  params.next_product_information =  Request.GetFormField("next_product_information")? true: false;
  params.next_newsletter =  Request.GetFormField("next_newsletter")? true: false;
  params.next_promotions =  Request.GetFormField("next_promotions")? true: false;
  params.next_mathletics =  Request.GetFormField("next_mathletics")? true: false;
  params.next_mathseeds =  Request.GetFormField("next_mathseeds")? true: false;
  params.next_reading_eggs =  Request.GetFormField("next_reading_eggs")? true: false;
  params.next_status =  Request.GetFormField("next_status")? true: false;


  //debug
  for (var key in params) {
    Write(key + ': ' + params[key] + '<br>');
  };
  Write('<br>');




  /*******************************************
  -- UPDATE MC PROFILE & PREFERENCE ATTRIBUTES
  ********************************************/  

  %%[/*

  NB: this function currently has the feature
  of not updating any of the profile/preference 
  attributes if the status is set to 
  'Unsubscribed'. This causes the quirk in the
  prefrences UI of not update anything if 
  'Subscribe to all Emails' is set to off.

  */]%%


  try {

    for (var i=0; i<params.subscriber_keys.length; i++) {

      var response = Subscriber.Init(params.subscriber_keys[i]).Update({
        "Status": params.next_status?'Active': 'Unsubscribed',
        Attributes:{
          "Birthdate": new Date(params.next_birthdate),
          //   "Mobile Number": params.next_mobile_number,
          "newsletter": params.next_newsletter, 
          "product information": params.next_product_information, 
          "promotions": params.next_promotions,
          "Mathletics_3PL": params.next_mathletics, 
          "ReadingEgg_3PL": params.next_mathletics, 
          "Mathseeds_3PL": params.next_mathseeds
        }
      }); 

      Write('response: '+response+'<br>')

    }//for

  } catch(e) {
    Write('error: '+Stringify(e)+'<br><br>')
  }










  /****************************************************
  -- UPDATE PUBLICATION LISTS
  *****************************************************/


  //Product Updates
  if (params.previous_product_information !== params.next_product_information) {
    var product_information_list = List.Init("Product Updates - 20739")
    for (var i=0; i<params.subscriber_keys.length; i++) { 
      product_information_list.Subscribers.Upsert(
        {SubscriberKey: params.subscriber_keys[i], EmailAddress: params.email_address},
        {Status: params.next_product_information? 'Active': 'Unsubscribed'}
      );
    }//for
  }//if

  //Newsletter
  if (params.previous_newsletter !== params.next_newsletter) {
    var newsletterList = List.Init("Newsletter - 20739")
    for (var i=0; i<params.subscriber_keys.length; i++) { 
      newsletterList.Subscribers.Upsert({SubscriberKey: params.subscriber_keys[i], EmailAddress: params.email_address },{Status: params.next_newsletter? 'Active': 'Unsubscribed'});
    }//for
  }//if


  //Features and Promotions
  if (params.previous_promotions !== params.next_promotions) {
    var featuresAndPromotionsList = List.Init("Features and Promotions - 20739")
    for (var i=0; i<params.subscriber_keys.length; i++) { 
      featuresAndPromotionsList.Subscribers.Upsert({SubscriberKey: params.subscriber_keys[i], EmailAddress: params.email_address },{Status: params.next_promotions? 'Active': 'Unsubscribed'});
    }//for
  }//if


  //Mathletics
  if (params.previous_mathletics !== params.next_mathletics) {
    var mathleticsList = List.Init("Mathletics - 20739")
    for (var i=0; i<params.subscriber_keys.length; i++) { 
      mathleticsList.Subscribers.Upsert({SubscriberKey: params.subscriber_keys[i], EmailAddress: params.email_address },{Status: params.next_mathletics? 'Active': 'Unsubscribed'});
    }//for
  }//if


  //Mathseeds
  if (params.previous_mathseeds !== params.next_mathseeds) {
    var mathseedsList = List.Init("Mathseeds - 20739")
    for (var i=0; i<params.subscriber_keys.length; i++) { 
      mathseedsList.Subscribers.Upsert({SubscriberKey: params.subscriber_keys[i], EmailAddress: params.email_address },{Status: params.next_mathseeds? 'Active': 'Unsubscribed'});
    }//for
  }//if


  //Reading Eggs
  if (params.previous_reading_eggs !== params.next_reading_eggs) {
    var readingEggsList = List.Init("Reading Eggs - 20739")
    for (var i=0; i<params.subscriber_keys.length; i++) { 
      readingEggsList.Subscribers.Upsert({SubscriberKey: params.subscriber_keys[i], EmailAddress: params.email_address },{Status: params.next_reading_eggs? 'Active': 'Unsubscribed'});
    }//for
  }//if


</script>


<!--
/*****************************************
UPDATE PREFERENCES (SALESFORCE CRM)
*****************************************/
-->
%%[

  /*************************************
   GET & CALCULATE PREFRENCES
  *************************************/

/*
  SET @RELATED_SUBSCRIBER_KEYS = BuildRowSetFromString(RequestParameter("subscriber_keys"), ",")

  SET @HAS_OPTED_OUT_OF_EMAIL = IIF(RequestParameter("next_status"), 1, 0)

  SET @MARKETING_PRODUCT_INTEREST__C = Concat("",
   IIF(RequestParameter("next_mathletics"), "Mathletics;", ""),
   IIF(RequestParameter("next_mathseeds"), "Mathseeds;", ""),
   IIF(RequestParameter("next_reading_eggs"), "ReadingEggs;", ""),
  )/*concat*/
  IF Empty(@MARKETING_PRODUCT_INTEREST__C) THEN SET @MARKETING_PRODUCT_INTEREST__C = "None" ENDIF

  SET @MARKETING_INTEREST__C = Concat("",
   IIF(RequestParameter("next_product_information"), "Product Information;", ""),
   IIF(RequestParameter("next_newsletter"), "Newsletter;", ""),
   IIF(RequestParameter("next_promotions"), "Promotions;", ""),
  )/*concat*/
  IF Empty(@MARKETING_INTEREST__C) THEN SET @MARKETING_INTEREST__C = "None" ENDIF
*/


  /*==================================================
   ONLY UDPATE LEAD OR CONTACT RELATED SUBSCRIBER KEYS
  ====================================================*/

/*
  FOR @i=1 TO RowCount(@RELATED_SUBSCRIBER_KEYS) DO

    SET @EACH_SUBSCRIBER_KEY = Field(Row(@RELATED_SUBSCRIBER_KEYS, @i), 1)

    IF Substring(@EACH_SUBSCRIBER_KEY,1,3) == '003' THEN SET @SALESFORCE_OBJECT_TYPE = "Contact" 
    ELSEIF Substring(@EACH_SUBSCRIBER_KEY,1,3) == '00Q' THEN SET @SALESFORCE_OBJECT_TYPE = "Lead" 
    ELSE VAR @SALESFORCE_OBJECT_TYPE ENDIF

    SET @TOTAL_RECORDS_UPDATED=0
    IF NOT Empty(@SALESFORCE_OBJECT_TYPE) THEN

      SET @RECORD_UPDATED = UpdateSingleSalesforceObject(
        @SALESFORCE_OBJECT_TYPE, 
        @EACH_SUBSCRIBER_KEY, 
        'HasOptedOutOfEmail', @HAS_OPTED_OUT_OF_EMAIL, 
        'Marketing_Product_Interest__c', @MARKETING_PRODUCT_INTEREST__C, 
        'Marketing_Interest__c', @MARKETING_INTEREST__C
        ) 

      SET @TOTAL_RECORDS_UPDATED = @TOTAL_RECORDS_UPDATED + @RECORD_UPDATED
    ENDIF

  NEXT @i
*/


]%%




<script runat="server">

  /*****************************************
   REDIRECT
  *****************************************/

  //success
  Redirect("https://cloud.my.3plearning.com/thankyou_preferences",false);

</script>
















