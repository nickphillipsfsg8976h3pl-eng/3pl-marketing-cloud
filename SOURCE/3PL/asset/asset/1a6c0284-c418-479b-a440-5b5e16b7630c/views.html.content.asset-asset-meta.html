%%[
    
SET @SubscriberKey = RequestParameter("subkey") 
SET @type = RequestParameter("type") 
SET @reason = "One click unsubscribe"
    IF empty(@SubscriberKey) OR empty(@type) THEN 
    SET @redirect = Redirect(CloudPagesURL(2572)) 
    ELSE 
    SET @productupdates = RequestParameter("product") 
    SET @newsletter = RequestParameter("newsletter") 
    SET @features = RequestParameter("features") 
    SET @unsuball = RequestParameter("unsubfromall") 
    SET @mathletics = RequestParameter("mathletics")
    SET @readiwriter = RequestParameter("readiwriter-spelling")
    SET @spellodrome = RequestParameter("spellodrome") 
    SET @readingeggs = RequestParameter("readingeggs") 
    SET @wordflyers = RequestParameter("wordflyers") 
    SET @mathseeds = RequestParameter("mathseeds") 
    SET @stemscopes = RequestParameter("stemscopes") 
    SET @gooseberryplanet = RequestParameter("gooseberry") ENDIF 

    /* Confirm the Marketing Product Interest values*/ 
    SET @updatemarketingproduct = ''
    IF @gooseberryplanet == 1 THEN 
    SET @updatemarketingproduct = CONCAT(@updatemarketingproduct, 'Gooseberry Planet;') ENDIF 
    IF @wordflyers == 1 THEN 
    SET @updatemarketingproduct = CONCAT(@updatemarketingproduct, 'WordFlyers;') ENDIF 
    IF @stemscopes == 1 THEN 
    SET @updatemarketingproduct = CONCAT(@updatemarketingproduct, 'STEMscopes;') ENDIF 
    IF @mathseeds == 1 THEN 
    SET @updatemarketingproduct = CONCAT(@updatemarketingproduct, 'Mathseeds;') ENDIF 
    IF @readingeggs == 1 THEN 
    SET @updatemarketingproduct = CONCAT(@updatemarketingproduct, 'ReadingEggs;') ENDIF 
    IF @spellodrome == 1 THEN 
    SET @updatemarketingproduct = CONCAT(@updatemarketingproduct, 'Spellodrome;') ENDIF
    IF @readiwriter == 1 THEN 
    SET @updatemarketingproduct = CONCAT(@updatemarketingproduct, 'Readiwriter Spelling;') ENDIF 
    IF @mathletics == 1 THEN 
    SET @updatemarketingproduct = CONCAT(@updatemarketingproduct, 'Mathletics;') ENDIF 
    IF @updatemarketingproduct == ''
    THEN 
    SET @updatemarketingproduct = 'None'
    ENDIF 
    /* Has opted out of email */ 
    IF @unsuball == 1 THEN 
    SET @unsub = 1 
    SET @statusforsubs = "Unsubscribed"
    ELSE 
    SET @unsub = 0 
    SET @statusforsubs = "Active"
    ENDIF 
    /*Confirm the Marketing Interest values*/ 
    SET @updatemarketinginterest = ''
    IF @features == 1 THEN 
    SET @updatemarketinginterest = CONCAT(@updatemarketinginterest, 'Promotions;') ENDIF 
    IF @newsletter == 1 THEN 
    SET @updatemarketinginterest = CONCAT(@updatemarketinginterest, 'Newsletter;') ENDIF 
    IF @productupdates == 1 THEN 
    SET @updatemarketinginterest = CONCAT(@updatemarketinginterest, 'Product information;') ENDIF 
    IF @updatemarketinginterest == '' THEN 
    SET @updatemarketinginterest = 'None'
    ENDIF 

    /* Lets update consent in All Subs */ 
    SET @actsub = CreateObject("Subscriber") 
    SetObjectProperty(@actsub, "SubscriberKey", @SubscriberKey) 
    SetObjectProperty(@actsub, "Status", @statusforsubs) 
    Set @options = CreateObject("UpdateOptions")
    Set @save = CreateObject("SaveOption") 
    SetObjectProperty(@save, "SaveAction", "UpdateAdd") 
    SetObjectProperty(@save, "PropertyName", "*") 
    AddObjectArrayItem(@options, "SaveOptions", @save) 
    SET @updateStatusCode = InvokeUpdate(@actsub, @updateStatusMessage, @updateErrorCode, @options) 
    SET @message = 1 

    /*If the update was successful, lets update Salesforce CRM*/ 

    IF @message == 1 THEN 
    SET @updaterecord = UpdateSingleSalesforceObject(@type, @subscriberkey, 'Email', @email, 'HasOptedOutOfEmail', @unsub, 'Marketing_Product_Interest__c', 
      @updatemarketingproduct, 'Marketing_Interest__c', @updatemarketinginterest) 
       IF @updaterecord == 1 THEN 
       SET @message = 1 ELSE 
       SET @message = 0 
       ENDIF 
    ELSE 
    SET @message = 0 
    ENDIF 
    SET @successmessage = CloudPagesURL(2573) 
    SET @errormessage = CloudPagesURL(2572) 

    IF @message == 1 THEN 
    SET @final = Redirect(@successmessage) 
    ELSE 
    SET @final = Redirect(@errormessage) 
    ENDIF
]%%
