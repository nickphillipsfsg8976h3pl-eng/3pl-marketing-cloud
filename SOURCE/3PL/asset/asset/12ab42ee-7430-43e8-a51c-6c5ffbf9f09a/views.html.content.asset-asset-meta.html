%%[ 
/* Get the page parameters */
SET @Email = RequestParameter("email")
SET @CampaignId = RequestParameter('cid')
SET @sfcid = Requestparameter('sfcid')
SET @FirstName = RequestParameter("first-name")
SET @LastName = RequestParameter("last-name")
SET @Phone = RequestParameter("phone")
SET @JobTitle = RequestParameter("job-title")
SET @Country = RequestParameter("country")
SET @countryName = RequestParameter("selectedCountryName")
SET @Postcode = RequestParameter("postcode")
SET @YearLevel = RequestParameter("year-select")
SET @source = RequestParameter("Source")
SET @State = RequestParameter("state")
SET @stateName = RequestParameter("selectedStateName")
SET @SchoolName = RequestParameter("school-name")
SET @UTMcampaign = RequestParameter("utmcampaign")
SET @UTMcontent = RequestParameter("utmcontent")
SET @UTMmedium = RequestParameter("utmmedium")
SET @UTMsource = RequestParameter("utmsource")
SET @UTMterm = RequestParameter("utmterm")
SET @enquiry = RequestParameter("eid")
SET @Product = RequestParameter("pid")
SET @Redirect = RequestParameter("rid")
SET @sfcid = Requestparameter('sfcid')
SET @products = RequestParameter("products")

/*Check Terms and conditions results*/
SET @MarketingInterest = RequestParameter("sub-opt-in")
SET @ProductInterest = RequestParameter("productinterest") /*Replace me with a Lookup to the campaign interest area - there are currently no obvious fields for this so it is passed as a parameter instead*/
SET @prodint = CONCAT(@ProductInterest,';')
SET @TermsCond = RequestParameter("tc-agree")
IF @TermsCond == 'agree' THEN
 SET @terms = 1
ELSE
 SET @terms = 0
ENDIF

/*Default settings*/
SET @today = SystemDateToLocalDate(NOW())
SET @SynctoMC = 1
SET @LeadStatus = 'Marketing Lead'


/*  any of these are empty set error message */
IF @Email == '' OR EMPTY(@Email) THEN 
 SET @ErrorResult = 1
 SET @Email = 'missing@missing.com.au'
ELSEIF @SchoolName == '' OR EMPTY(@SchoolName) THEN 
 SET @ErrorResult = 1
ELSEIF @State == '' OR EMPTY(@State) THEN 
 SET @ErrorResult = 1
ELSEIF @CampaignId == '' OR EMPTY(@CampaignId) THEN 
 SET @ErrorResult = 1
  SET @CampaignId = 'No campaign'
ELSEIF @FirstName == '' OR EMPTY(@FirstName) THEN 
 SET @ErrorResult = 1
 SET @FirstName = 'No name'
ELSEIF @LastName == '' OR EMPTY(@LastName) THEN 
 SET @ErrorResult = 1
  SET @LastName = 'No name'
ELSEIF @Phone == '' OR EMPTY(@Phone) THEN 
 SET @ErrorResult = 1
 SET @Phone = '0400000000'
ELSEIF @JobTitle == '' OR EMPTY(@JobTitle) THEN 
 SET @ErrorResult = 1
 SET @JobTitle = 'No entry'
ELSEIF @Country == '' OR EMPTY(@Country) THEN 
 SET @ErrorResult = 1
 SET @Country = 'No entry'
ELSEIF @Postcode == '' OR EMPTY(@Postcode) THEN 
 SET @ErrorResult = 1
  SET @Postcode = 'No entry'
ELSEIF @YearLevel == '' OR EMPTY(@YearLevel) THEN 
 SET @ErrorResult = 1
 SET @YearLevel = 'No entry'
ELSEIF @source == '' OR EMPTY(@source) THEN 
 SET @ErrorResult = 1
 SET @source = 'No entry'
ELSE 
 SET @ErrorResult = 0
ENDIF

/*There is a blank parameter and we need to redirect to the error page*/
IF @ErrorResult == 1 THEN     
 SET @updateerrorlog = InsertData('TrialErrorLog','Email',@Email,'CampaignId',@CampaignId,'FirstName',@FirstName,'LastName',@LastName,'Phone',@Phone,'JobTitle',@JobTitle,'Country',@Country,'PostCode',@Postcode,'YearLevel',@YearLevel,'Error','Blank field or parameter when completing form','EventDate',@today,'Source',@source)
ELSE   
/* VARIABLE VALUES for Marketing Interests */
 IF @MarketingInterest == 'receive' THEN
    SET @consent = 'Promotions; Newsletter; Product information'
  ELSE
    SET @consent = ''
 ENDIF
    /* No missing parameters we will log the results before updating CRM */
    SET @updatelog = InsertData('TrialLog','Email',@Email,'CampaignId', @CampaignId,'Firstname',@FirstName,'Lastname',@LastName,'Phone',@Phone,'JobTitle',@JobTitle,'Country',@Country,'PostCode',@Postcode,'YearLevel',@YearLevel,'EventDate',@today,'TermsConditionsAgree',@terms,'MarketingInterestAgree',@MarketingInterest,'Source',@source)
 IF @updatelog > 0 THEN 
    SET @ErrorResult = 0
        /* parameters are all provided then check for the Lead record */
     SET @LeadSub = RetrieveSalesforceObjects(
       'Lead', 
       'Id, Email, IsConverted, Status, Marketing_Product_Interest__c, ConvertedContactId', 
       'Email', '=', @Email)
        /*  there is a Lead record already check if they are converted or not */
      IF RowCount(@LeadSub) > 0 THEN 
         SET @SubRow1 = Row(@LeadSub, 1)
         SET @LeadEmail = Field(@SubRow1, "Email")
         SET @LeadID = Field(@SubRow1,"Id")
         SET @IsConverted = Field(@SubRow1, "IsConverted")
         SET @Status = Field(@SubRow1, "Status")
         SET @ContactId = Field(@SubRow1, "ConvertedContactId") 
         SET @Product = Field(@SubRow1, "Marketing_Product_Interest__c")
            
            /*Has the lead converted*/
            IF @IsConverted == 0 THEN
                IF INDEXOF(@Product,@prodint) > 0 THEN
                    SET @productpref = @Product
                ELSE
                    SET @productpref = CONCAT(@prodint,@Product) 
                ENDIF
                    SET @updatelead = UpdateSingleSalesforceObject(
                    'Lead', @LeadID,
                    'Marketing_Product_Interest__c', @productpref,
                    'Sync_to_Marketing_Cloud__c',@SynctoMC,
                    'Marketing_Interest__c',@consent
             )
                IF @updatelead == 1 THEN 
                     SET @ErrorResult = 0
                ELSE 
                     SET @ErrorResult = 'Line 102'
                ENDIF
                IF @Status IS NULL OR @Status == '' THEN
                    SET @updatelead = UpdateSingleSalesforceObject('Lead', @LeadID, 'Status', @LeadStatus)
                    IF @updatelead == 1 THEN 
                         SET @ErrorResult = 0
                    ELSE 
                         SET @ErrorResult = 'Line 109'
                    ENDIF
                    SET @Id = @LeadID
                    SET @type = 'Lead'
                    SET @updatelog = UpdateData('TrialLog',3,'Email',@Email,'EventDate',@today,'CampaignId', @CampaignId,
                   'Id',@Id)
                ENDIF
       SET @lookupsubscriber = RetrieveSalesforceObjects('CampaignMember', 'Id, Status', 'LeadOrContactId', '=', @Id, 'CampaignId', '=', @CampaignId)
        /* the campaign member exists already */
        IF RowCount(@lookupsubscriber) > 0 THEN 
                 SET @addtocampaign = 0
              ELSE
                  /* Campaign member doesnt exist lets add to Campaign */
                 SET @addtocampaign = CreateSalesforceObject('CampaignMember', 3, 
        'CampaignId', @CampaignId,
        'LeadId', @LeadID,
        'Status', 'Sent'
        )   
              ENDIF
      ELSE
       /*The lead is converted to a contact lets look for their contact in the campaign */
    SET @Id = @ContactId
                SET @type = 'Contact'
                SET @ContactSub = RetrieveSalesforceObjects('Contact', 'Id, Email, Marketing_Product_Interest__c', 'Email', '=', @Email)
                IF RowCount(@ContactSub) > 0 THEN 
                    SET @SubRow1 = Row(@ContactSub, 1)
                    SET @ContactEmail = Field(@SubRow1, "Email")
                    SET @ContactID = Field(@SubRow1,"Id")
                    SET @Product = Field(@SubRow1, "Marketing_Product_Interest__c") 
                      
                    /*What are the current product interests */           
                    IF INDEXOF(@Product,@prodint) > 0 THEN
                        SET @productpref = @Product
                    ELSE
                        SET @productpref = CONCAT(@prodint,@Product)
                    ENDIF
                    SET @updatecontact = UpdateSingleSalesforceObject('Contact', 
                    @ContactID,
                    'Marketing_Product_Interest__c', @productpref,
                    'Sync_to_Marketing_Cloud__c',@SynctoMC,
                    'Marketing_Interest__c',@consent
                    )
                    IF @updatecontact == 1 THEN 
                        SET @ErrorResult = 0
                    ELSE 
                        SET @ErrorResult = 'Line 154'
                    ENDIF
         SET @lookupsubscriber = RetrieveSalesforceObjects('CampaignMember', 'Id, Status', 'LeadOrContactId', '=', @Id, 'CampaignId', '=', @CampaignId)
         /* the campaign member exists in CampaignMember get their record details for logging */
         IF RowCount(@lookupsubscriber) > 0 THEN 
                    SET @addtocampaign = 0
                ELSE
                   /* Campaign member doesnt exist lets add to Campaign */
                    SET @addtocampaign = CreateSalesforceObject('CampaignMember', 3, 
        'CampaignId', @CampaignId,
        'ContactId', @ContactID,
        'Status', 'Sent'
        )
                ENDIF
                ENDIF
            ENDIF  
  ELSE
         /*The lead doesnt exist so lets create it and add it as a campaign member */
   SET @createrecord = CreateSalesforceObject('Lead', 12, 
            'FirstName', @FirstName, 
            'LastName', @LastName, 
            'Email', @Email, 
            'Status', 'Marketing Lead',
            'Country',@Country,
            'Company','Test',
            'Phone',@Phone,
            'Job_Function__c',@JobTitle,
            'PostalCode',@Postcode,
            'Sync_to_Marketing_Cloud__c',1,
            'Marketing_Interest__c',@consent,
            'Marketing_Product_Interest__c',@prodint
            )
            /* Campaign member doesnt exist lets add to Campaign */
            SET @addtocampaign = CreateSalesforceObject('CampaignMember', 3, 
   'CampaignId', @CampaignId,
   'LeadId', @createrecord,
   'Status', 'Sent'
   )
            SET @type = 'MQL'
            SET @ErrorResult = 0
            
    ENDIF
  ELSE
    SET @ErrorResult = 'line 182'
  ENDIF
ENDIF

/*Now we know who to add to campaigns*/
IF @ErrorResult != 1 THEN
 SET @redirect = CloudPagesURL(1992)
ELSE
 SET @redirect =  CloudPagesURL(1991)
ENDIF

/* Redirect to error or success page */
SET @finalredirect = Redirect(@redirect)

]%%
No breaks yet and the error result is %%=v(@ErrorResult)=%%
<br/>%%=v(@Email)=%%
<br/>%%=v(@FirstName)=%%
<br/>%%=v(@LastName)=%%
<br/>%%=v(@Phone)=%%
<br/>%%=v(@JobTitle)=%%
<br/>%%=v(@Country)=%%
<br/>%%=v(@Postcode)=%%
<br/>Error result: %%=v(@ErrorResult)=%%
<br/>Update error log: %%=v(@updateerrorlog)=%%