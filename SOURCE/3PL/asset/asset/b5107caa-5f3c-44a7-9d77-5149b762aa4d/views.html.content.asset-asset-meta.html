%%[

VAR @phone, @sf_cid_input

SET @nocontact = RequestParameter("nocontact")
SET @tsid = RequestParameter("tsid")
SET @pid = RequestParameter('pid')
SET @Campaign = Requestparameter('cid')
SET @sfcid = Requestparameter('sfcid')
SET @sf_cid_name = Requestparameter('sfcid')

IF empty(@sfcid) THEN
SET @sf_cid_input = ""
ELSE
SET @sf_cid_input = "GLOBAL_AT0001"
ENDIF

IF @Campaign == "7012y000000Y6IFAA0" THEN
SET @LeadSource = "Distributor"
ELSE
SET @LeadSource = "Marketing Cloud"
ENDIF



IF @nocontact == "1" THEN


IF @pid == "Mathletics" THEN
SET @FirstName = Lookup('TriggeredSendDe_Auto-Trial_Mathletics','FirstName','SubscriberKey',@tsid)
SET @LastName = Lookup('TriggeredSendDe_Auto-Trial_Mathletics','LastName','SubscriberKey',@tsid)
SET @Email = Lookup('TriggeredSendDe_Auto-Trial_Mathletics','EmailAddress','SubscriberKey',@tsid)
SET @Product = Lookup('TriggeredSendDe_Auto-Trial_Mathletics','Product','SubscriberKey',@tsid)
SET @jobTitle = Lookup('TriggeredSendDe_Auto-Trial_Mathletics','job-title','EmailAddress',@Email)
SET @cid = Lookup('TriggeredSendDe_Auto-Trial_Mathletics','isReceiveEmail','EmailAddress',@Email)
SET @SFSC_Id = Lookup('TriggeredSendDe_Auto-Trial_Mathletics','cid','EmailAddress',@Email)
ELSE
SET @FirstName = Lookup('TriggeredSendDe_Auto-Trial_Readiwriter','FirstName','SubscriberKey',@tsid)
SET @LastName = Lookup('TriggeredSendDe_Auto-Trial_Readiwriter','LastName','SubscriberKey',@tsid)
SET @Email = Lookup('TriggeredSendDe_Auto-Trial_Readiwriter','EmailAddress','SubscriberKey',@tsid)
SET @Product = Lookup('TriggeredSendDe_Auto-Trial_Readiwriter','Product','SubscriberKey',@tsid)
SET @jobTitle = Lookup('TriggeredSendDe_Auto-Trial_Readiwriter','job-title','EmailAddress',@Email)
SET @isReceiveEmail = Lookup('TriggeredSendDe_Auto-Trial_Readiwriter','isReceiveEmail','EmailAddress',@Email)
SET @SFSC_Id = Lookup('TriggeredSendDe_Auto-Trial_Readiwriter','cid','EmailAddress',@Email)
ENDIF

SET @countryCode = RequestParameter("country")
SET @countryName = RequestParameter("selectedCountryName")
SET @stateCode = RequestParameter("state")
SET @stateName = RequestParameter("selectedStateName")
SET @phone = TRIM(RequestParameter("phone"))
SET @program = TRIM(RequestParameter("program"))
SET @needs = TRIM(RequestParameter("needs"))
SET @postcode = RequestParameter("postcode")
SET @schoolName = TRIM(RequestParameter("school-name"))
SET @schoolEnquiryQuestionId = RequestParameter("enquiry-select-school-user")
SET @homeEnquiryQuestionId = RequestParameter("enquiry-select-home-user")
SET @LeadStatus = "MQL"
SET @LeadCustomerLeadTypeId = "0120I0000019a2jQAA"
SET @schoolName = TRIM(RequestParameter("school"))
SET @Campaign = RequestParameter("cid")
SET @UTMcontent = RequestParameter("utmcontent")
SET @UTMcampaign = RequestParameter("utmcampaign")
SET @UTMmedium = RequestParameter("utmmedium")
SET @UTMsource = RequestParameter("utmsource")
SET @UTMterm = RequestParameter("utmterm")
SET @enquiry = RequestParameter("eid")
SET @pid = RequestParameter("pid")
SET @updatemarketinginterest = 'Promotions;Product information;'


/* START - PRODUCT DEFINITION */

IF @pid == 'Mathletics' OR 'mathletics' THEN
SET @product = 'Mathletics'
SET @pcode = 'mathletics-auto-trial'

ELSEIF @pid == 'Readiwriter' OR 'readiwriter' THEN
SET @product = 'Readiwriter Spelling'
SET @pcode = 'readiwriter-spelling-auto-trial'

ENDIF


/* START - Campaign Fallback definition */


IF empty(@Campaign) AND @pid == 'Mathletics' THEN
SET @Campaign = '7010I000001e0btQAA'
ELSEIF empty(@Campaign) AND @pid == 'Readiwriter' THEN
SET @Campaign = '7012y000000HIBBAA4'
ELSE
SET @Campaign = Requestparameter('cid')
ENDIF


/* START - Testing for state */

SET @productCode = RequestParameter("pid")


IF empty(@productCode) THEN
SET @productCode = "NULL"
ENDIF




/* START - Register for newsletter */

SET @updatemarketinginterest = 'Promotions;Product information;'


IF @isReceiveEmail == 'True' THEN
SET @updatemarketinginterest = CONCAT(@updatemarketinginterest, 'Newsletter;')
ENDIF


/* START - HOME/PARENT Redirect */

IF @schoolName == '' THEN
SET @schoolName = 'Free Trial'
ENDIF

If @jobTitle == 'Parent' OR 'Home schooling parent' THEN
SET @customerType = 'Home'
ELSE
SET @customerType = 'School'
ENDIF

/* create Lead in Salesforce */

SET @leadId = CreateSalesforceObject("Lead",
31, /* Number of fields specified to add in the Lead record */
"LeadSource", @LeadSource,
"Campaign_Name__c", @sf_cid_input,
"Campaign_Code__c", @sf_cid_name,
"UTM_Content__c", @UTMContent,
"UTM_Campaign__c", @UTMcampaign,
"UTM_Medium__c", @UTMmedium,
"UTM_Source__c", @UTMsource,
"UTM_Term__c", @UTMterm,
"Status", @LeadStatus,
"RecordTypeId", @LeadCustomerLeadTypeId,
"Territory__c", @LeadTerritory,
"Enquiry_Type__c", "Trial",
"FirstName", @firstName,
"LastName", @lastName,
"Company", @schoolName,
"Phone", @phone,
"Resource__c", @program,
"Key_Objectives__c", @needs,
"Title", @jobTitle,
"Email", @email,
"Marketing_Product_Interest__c", @product,
"Product_family__c", @product,
"Product_Interest__c", @product,
"Marketing_Interest__c", @updatemarketinginterest,
"Create_Sandbox__c", "true",
"Product_Code__c", @pcode,
"Country__c", @countryName,
"CountryCode", @countryCode,
"State__c", @stateName,
"StateCode", @stateCode,
"PostalCode", @postcode
)

set @campaignMemberId = CreateSalesforceObject('CampaignMember', 3, 'CampaignId', @Campaign, 'LeadId',
@leadId,'Status','Sent')



SET @schoolName = TRIM(RequestParameter("school"))
SET @ContactId = RequestParameter("contactid")



ENDIF

/* START - UPDATE AND LOOKUP TRIGGERSEND DE */
IF @pid == 'Mathletics' THEN
SET @Confirmed = UpdateData('TriggeredSendDe_Auto-Trial_Mathletics',1,'SubscriberKey',@tsid,'Confirmed','TRUE')
SET @product_DE = Lookup('TriggeredSendDe_Auto-Trial_Mathletics','Product','SubscriberKey',@tsid)
SET @Sub_DE = UpdateData('TriggeredSendDe_Auto-Trial_Mathletics',1,'SubscriberKey',@tsid,'SubscriberKey',@leadId)
SET @Sub_Backup_DE = UpdateData('TriggeredSendDe_Auto-Trial_Mathletics',1,'SubscriberKey',@tsid,'SubscriberKey',@leadId)
ELSE
SET @Confirmed = UpdateData('TriggeredSendDe_Auto-Trial_Readiwriter',1,'SubscriberKey',@tsid,'Confirmed','TRUE')
SET @product_DE = Lookup('TriggeredSendDe_Auto-Trial_Readiwriter','Product','SubscriberKey',@tsid)
SET @Sub_DE = UpdateData('TriggeredSendDe_Auto-Trial_Readiwriter',1,'SubscriberKey',@tsid,'SubscriberKey',@leadId)
SET @Sub_Backup_DE =
UpdateData('TriggeredSendDe_Auto-Trial_Readiwriter',1,'SubscriberKey',@tsid,'SubscriberKey',@leadId)
ENDIF

/* START - ERROR HANDLING REDIRECT */

SET @successmessage_Mathletics = "https://www.mathletics.com/for-schools/free-trial/complete-registration/"
SET @successmessage_Readiwriter = "https://www.3plearning.com/software/readiwriter/free-trial/complete-registration/"
SET @errormessage_Mathletics = "https://www.mathletics.com/for-schools/free-trial/access-your-login/"
SET @errormessage_Readiwriter = "https://www.3plearning.com/software/readiwriter/free-trial/access-your-login/"

if @product_DE == 'Mathletics' OR 'mathletics' AND @Confirmed == "TRUE" then
SET @final = Redirect(@successmessage_Mathletics)

ELSEIF @Product_DE == 'Readiwriter' OR 'readiwriter' AND @Confirmed == "TRUE" THEN
SET @final = Redirect(@successmessage_Readiwriter)

ELSEIF @Product_DE == 'Mathletics' OR 'mathletics' AND @Confirmed == "FALSE" THEN
SET @final = Redirect(@errormessage_Mathletics)

ELSEIF @Product_DE == 'Readiwriter' OR 'readiwriter' AND @Confirmed == "FALSE" THEN
SET @final = Redirect(@errormessage_Readiwriter)

ENDIF


]%%