%%[

    set @subscriberkey = AttributeValue("_subscriberkey")
    set @JobID         = AttributeValue("jobid")
    set @listid        = AttributeValue("listid")
    set @batchid       = AttributeValue("_JobSubscriberBatchID")
    set @email_address = AttributeValue("emailaddr")
    set @EMAIL_NAME    = AttributeValue("emailname_")
    set @debug         = true
]%%
<script runat="server">
Platform.Load("Core","1");

  
var emailToLookup = Platform.Variable.GetValue("@email_address");

try {
    var rr = Platform.Function.LookupRows("Ent._Subscribers","EmailAddress", emailToLookup);
    var subscriberKeys = [];

    if (rr && rr.length > 0) {
        for (var i = 0; i < rr.length; i++) {
            var subscriberKey = rr[i].SubscriberKey;
            subscriberKeys.push(subscriberKey);
        }
    }

    Write("SubscriberKeys associated with email address " + emailToLookup + ": " + subscriberKeys.join(', '));
    Variable.SetValue("@SubscriberKeys", subscriberKeys.join(','));
} catch (e) {
    Write("An error occurred: " + Stringify(e));
}
</script>
%%[

 
    if @debug == true then
                OutputLine(Concat('
                    <pre style="background-color:#ccc;"><code>Subscriber: ', @subscriberkey, '</code></pre>'))
                OutputLine(Concat('
                    <pre style="background-color:#ccc;"><code>SUBSCRIBER_KEYS: ', @SubscriberKeys, '</code></pre>'))
                OutputLine(Concat('
                    <pre style="background-color:#ccc;"><code>EmailAddrs: ', @email_address, '</code></pre>'))
                OutputLine(Concat('
                    <pre style="background-color:#ccc;"><code>Email Name: ', @EMAIL_NAME, '</code></pre>'))
                OutputLine(Concat('
                    <pre style="background-color:#ccc;"><code>EmailJobID: ', @JobID, '</code></pre>'))
                OutputLine(Concat('
                    <pre style="background-color:#ccc;"><code>EmailBatchID: ', @batchid, '</code></pre>'))
                OutputLine(Concat('
                    <pre style="background-color:#ccc;"><code>@listid: ', @listid, '</code></pre>'))

    endif

    set @reason = "One click unsubscribe"

    set @unsuball = 1
    /* Has opted out of email */
    if @unsuball == 1 then
      set @unsub = 1
      set @statusforsubs = "Unsubscribed"
    else
      set @unsub = 0
      set @statusforsubs = "Active"
    endif
 
    set @SUBSCRIBER_KEYS_ROWS = BuildRowSetFromString(@SubscriberKeys, ",")
    set @TOTAL_RECORDS_UPDATED=0

    for @i=1 to RowCount(@SUBSCRIBER_KEYS_ROWS) do

      set @EACH_SUBSCRIBER_KEY = Field(Row(@SUBSCRIBER_KEYS_ROWS, @i), 1)



      /*Log unsub event*/
      set @lue = CreateObject("ExecuteRequest")
      setObjectProperty(@lue,"Name","LogUnsubEvent")
      set @lue_prop = CreateObject("APIProperty")
      setObjectProperty(@lue_prop, "Name", "SubscriberKey")
      setObjectProperty(@lue_prop, "Value", @EACH_SUBSCRIBER_KEY)
      AddObjectArrayItem(@lue, "Parameters", @lue_prop)
      set @lue_prop = CreateObject("APIProperty")
      setObjectProperty(@lue_prop, "Name", "JobID")
      setObjectProperty(@lue_prop, "Value", @JobID)
      AddObjectArrayItem(@lue, "Parameters", @lue_prop)
      set @lue_prop = CreateObject("APIProperty")
      setObjectProperty(@lue_prop, "Name", "ListID")
      setObjectProperty(@lue_prop, "Value", @listid)
      AddObjectArrayItem(@lue, "Parameters", @lue_prop)
      set @lue_prop = CreateObject("APIProperty")
      setObjectProperty(@lue_prop, "Name", "BatchID")
      setObjectProperty(@lue_prop, "Value", @batchid)
      AddObjectArrayItem(@lue, "Parameters", @lue_prop)
      set @lue_prop = CreateObject("APIProperty")
      setObjectProperty(@lue_prop, "Name", "Reason")
      setObjectProperty(@lue_prop, "Value", @reason)
      AddObjectArrayItem(@lue, "Parameters", @lue_prop)
      set @lue_statusCode = InvokeExecute(@lue, @overallStatus, @requestId)
      set @Response = Row(@lue_statusCode, 1)
      set @Status = Field(@Response,"StatusMessage")
      set @Error = Field(@Response,"ErrorCode")
      /* Lets update consent in All Subs */
      set @actsub = CreateObject("Subscriber")
      setObjectProperty(@actsub,"SubscriberKey", @EACH_SUBSCRIBER_KEY)
      setObjectProperty(@actsub,"Status",@statusforsubs)
      set @options = CreateObject("UpdateOptions")
      set @save = CreateObject("SaveOption")
      setObjectProperty(@save,"SaveAction","UpdateAdd")
      setObjectProperty(@save,"PropertyName","*")
      AddObjectArrayItem(@options,"SaveOptions", @save)
      set @updateStatusCode = InvokeUpdate(@actsub, @updateStatusMessage, @updateErrorCode, @options)

      set @updaterecord = 0
      set @updatetype   = ""
      /* Is this a lead or a contact*/
      if Substring(@EACH_SUBSCRIBER_KEY,1,3) == '003' then
        set @updatetype = "Contact"
      elseif Substring(@EACH_SUBSCRIBER_KEY,1,3) == '00Q' then
        set @updatetype = "Lead"
      endif

      set @message = 1

      if @updatetype == "Contact" OR @updatetype == "Lead" then
        set @updaterecord = UpdateSingleSalesforceObject(@updatetype,
            @EACH_SUBSCRIBER_KEY,
            'HasOptedOutOfEmail',@unsub
        )

        set @TOTAL_RECORDS_UPDATED = @TOTAL_RECORDS_UPDATED + @updaterecord
      endif

      if @debug == true then
                OutputLine(Concat('
                    <pre style="background-color:#ccc;"><code>EACH_SUBSCRIBER_KEY: ', @EACH_SUBSCRIBER_KEY, '</code></pre>'))
                OutputLine(Concat('
                    <pre style="background-color:#ccc;"><code>updateStatusCode: ', @updateStatusCode, '</code></pre>'))
                OutputLine(Concat('
                    <pre style="background-color:#ccc;"><code>updaterecord: ', @updaterecord, '</code></pre>'))
                OutputLine(Concat('
                    <pre style="background-color:#ccc;"><code>TOTAL_RECORDS_UPDATED: ', @TOTAL_RECORDS_UPDATED, '</code></pre>'))
      endif

      set @logtime = SystemDateToLocalDate(now())
      insertData("Unsubscribe_Log","SubscriberKey", @EACH_SUBSCRIBER_KEY,"EmailAddress",
                @email_address, "JobID", @JobID, "LogTime",@logtime,"EmailName",@EMAIL_NAME,
                "HAS_OPTED_OUT_OF_EMAIL", "1" ,"RECORD_UPDATED",@updaterecord,"Reason","One click unsubscribe")
                
  next @i

]%%

<html>

<head>
    <link rel="icon" type="image/png" sizes="32x32" href="https://www.3plearning.com/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="https://www.3plearning.com/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://www.3plearning.com/favicon-16x16.png">
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link rel="stylesheet" href="https://preferences.my.3plearning.com/test-preference-centre-css">
    <script src="https://marketing-cdn.3plearning.com/uploads/dev/assets/jquery.min.js"></script>
    <script src="https://marketing-cdn.3plearning.com/uploads/dev/assets/owl.carousel.js"></script>
    <link rel="stylesheet" href="https://marketing-cdn.3plearning.com/uploads/dev/assets/owl.carousel.min.css">
    <link rel="stylesheet" href="https://marketing-cdn.3plearning.com/uploads/dev/assets/owl.theme.default.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .owl-stage {
        display: -webkit-box;
        display: -moz-box;
        display: -ms-box;
        display: box;
        }
        owl nav */
        .owl-prev span, .owl-next span {
        color: #FFFFFF;
        }

        .owl-prev span:hover, 
        .owl-next span:hover {
        color: #8199A3;
        }

        .owl-prev, .owl-next {
        position: absolute;
        top: 0;
        height: 100%;
        }

        .owl-prev {
        left: 0px;
        }

        .fa, .fas {
        font-weight: 900;
        color: #b3b2b2;}
        .owl-next {
        right: 10px;
        }

        @media only screen and (max-width:480px){
        /* MOBILE GLOBAL STYLES - DO NOT CHANGE */
          body, .tb_properties{font-family: Arial !important; font-size: 16px !important; color: #808080 !important; line-height: 1 !important; padding: 0px !important; }.buttonstyles{font-family: Arial !important; font-size: 16px !important; color: #FFFFFF !important; padding: 0px !important; }h1{font-family: Arial !important; font-size: 22px !important; color: #202020 !important; line-height: 1 !important; }h2{font-family: Arial !important; font-size: 20px !important; color: #202020 !important; line-height: 1 !important; }h3{font-family: Arial !important; font-size: 18px !important; color: #202020 !important; line-height: 1 !important; }a:not(.buttonstyles){line-height: 1 !important; }.mobile-hidden{display: none !important; }.responsive-td {width: 100% !important; display: block !important; padding: 0 !important;}
        /* END OF MOBILE GLOBAL STYLES - DO NOT CHANGE */
        }
    </style>
</head>

<body class="">
    <nav class="" role="navigation">
        <div class="nav-wrapper container"><a id="logo-container" href="#" class="brand-logo"><img src="https://image.my.3plearning.com/lib/fe3211717d640479701476/m/1/4efa20c6-8ad4-448b-a37c-d1b457fe1210.gif"></a>
        </div>
    </nav>
    <div style="min-height: -webkit-fill-available;" class="container">
        <div class="row">
            <div style="width: 100%; margin-top: 50px;" class="col xs12">
                <div class="owl-carousel" width="150px">
                    <div class="item">
                        <img width="150px" src="https://image.my.3plearning.com/lib/fe3211717d640479701476/m/1/b5c88b13-45c4-4d4d-994d-9824e264d3c7.jpg" />
                    </div><br>
                    <div class="item" width="150px">
                        <img width="150px" src="https://image.my.3plearning.com/lib/fe3211717d640479701476/m/1/b6d63722-48ec-48f8-b975-6c26dbd7d323.png" />
                    </div><br>
                    <div class="item" width="150px">
                        <img width="150px" src="https://image.my.3plearning.com/lib/fe3211717d640479701476/m/1/97c4a26d-e585-470d-8d91-5142fe1f9457.png" />
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div align="center" class="col m8 offset-m2 center">
                <h1>
                    Sorry to see you go!
                </h1>
                <p style="font-size: 20px;">We’ve removed you from our mailing list, but we’ll always be happy to see you again.</p>
                <p style="margin-bottom: 40px;"> <em>Accidentally hit unsubscribe? You can resubscribe to receive the best 3P Learning news, resources, blogs and product updated by clicking the button below.</em></p>
                <a class="btn waves-effect waves-light" style="font-size: 20px;" href="https://cloud.my.3plearning.com/click_resubscribe?id=%%=v(@subscriberkey)=%%">Re-subscribe me</a>
            </div>
        </div>
        <div class="col m8 offset-m2 center">
            <img style="width: 100%; max-width: 596px;" src="https://marketing-cdn.3plearning.com/uploads/dev/assets/cryingpeas_v2.gif" />
        </div>
    </div>
    <script>
    var owl = $('.owl-carousel');
    owl.owlCarousel({
        margin: 10,
        loop: false,
        nav: true,
        dots: false,
        navText: ['<span class="fas fa-chevron-left fa-2x"></span>', '<span class="fas fa-chevron-right fa-2x"></span>'],
        responsive: {
            0: {
                items: 1
            },
            600: {
                items: 3
            },
            1000: {
                items: 7
            }
        }
    })
    </script>

    <!--END CONTAINER-->
    <footer class="page-footer">
        <div class="footer-copyright">
            <div class="container">
                <div class="row">
                    <div class="col l6 m12 s12 left-align copyright-left">
                        <p class="">Copyright %%=Format(Now(), "yyyy")=%%. <a href="https://www.3plearning.com/">3P Learning</a> - Transforming lives through a love of learning.</p>
                    </div>
                    <div class="col l6 m12 s12 right-align copyright-right">
                        <p class="grey-text darken-3">
                            <a class="" href="http://www.3plearning.com/hello/">About Us</a>&nbsp;&nbsp;|&nbsp;
                            <a class="" href="http://www.3plearning.com/careers/">Careers</a>&nbsp;&nbsp;|&nbsp;
                            <a class="" href="http://www.3plearning.com/contact/">Contact Us</a>&nbsp;&nbsp;|&nbsp;
                            <a class="" href="http://www.3plearning.com/privacy/">Privacy Policy</a>&nbsp;&nbsp;|&nbsp;
                            <a class="" href="http://www.3plearning.com/terms/">Terms &amp; Conditions</a>
                        </p>
                    </div>
                </div>
            </div>
            <!--END CONTAINER-->
        </div>
        <!--END FOOTER-->
    </footer>

</body>

</html>
   
