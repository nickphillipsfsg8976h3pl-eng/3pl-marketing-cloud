


<!-- 
/******************************
----- GLOBAL FORM SCRIPT ------
*******************************/
-->




%%[/*
=====================================================================================

Todo:

- replace & pass through cid/rid/eid/pid 
as campaign_name, redirect_page, enquiry_type, product_name

-add in 'debug' request parameter to cancel actions and show debug info

-add in a automatic create data extension function (if exists dont create)

LOGIC
======
1. if lead and contact exist
-> update contact
2. if lead exists and no contact
-> update lead
3. otherwise if none exist
-> create a lead 


=====================================================================================
*/]%%








%%[ 

        /*************************************************************
        -- GET REQUEST PARAMETERS
        **************************************************************/


        /* HIDDEN FIELDS
        *****************/

        set @_Debug             = RequestParameter("debug")

        set @form               = lowercase(RequestParameter('form')) 
        Set @_Campaign_Name     = RequestParameter("campaign-name")
        Set @_Triggered_Send_Key= RequestParameter("triggered-send-key")
        Set @_Redirect_To_Page  = RequestParameter("redirect-to-page")
        set @RedirectId         = RequestParameter("rid") 
        set @pid                = RequestParameter("pid") 
        set @cid                = RequestParameter("cid") 
        set @_UTM_Campaign      = RequestParameter("utm-campaign")
        set @_UTM_Content       = RequestParameter("utm-content")
        set @_UTM_Medium        = RequestParameter("utm-medium")
        set @_UTM_Source        = RequestParameter("utm-source")
        set @_UTM_Term          = RequestParameter("utm-term")
        set @gclid              = RequestParameter("gclid")
        set @referrer           = RequestParameter("referrer")
        set @http_referrer      = HTTPRequestHeader("referer")
        set @LeadID             = RequestParameter("LeadID")
        set @GUID               = RequestParameter("GUID")


        set @_UTM_Campaign_entry = IIF(Not Empty(@_UTM_Campaign), @_UTM_Campaign, "NA")
        
        if Empty(@_UTM_Campaign) then
            if not Empty(@_Campaign_Name) then
                set @campaignNameLookup = Lookup("ENT.Campaign_Salesforce", "Name", "Id",@_Campaign_Name)
                if not Empty(@campaignNameLookup) then
                    set @_UTM_Campaign_entry = @campaignNameLookup
                endif
            endif
        endif

        /* FORM FIELDS
        *****************/

        set @_Product_Interest    = RequestParameter("product-interest")
        set @_First_Name          = RequestParameter("first-name")
        set @_Last_Name           = RequestParameter("last-name")
        set @_Email_Address       = RequestParameter("email-address")
        set @_Phone_Number        = RequestParameter("phone-number")
        set @_Grade_Level         = RequestParameter("grade-level")
        set @_Job_Title           = RequestParameter("job_title_select")
        set @_Country_Name        = RequestParameter("country-name")
        set @_State_Name          = RequestParameter("state-name")
        set @_Postal_Code         = RequestParameter("postal-code")
        set @_School_Name         = RequestParameter("school-name")
        set @_No_Of_Licences      = RequestParameter("no-of-licences")
        set @_Terms_And_Conditions= RequestParameter("terms-and-conditions")
        set @_Subscriber_Opt_In   = RequestParameter("subscriber-opt-in")
        set @_Subject             = RequestParameter("subject_select")
        set @formattedSubjects    = ""

        if not Empty(@_Subject) then
             set @formattedSubjects = Concat(Replace(@_Subject, ",", ";"), ";")
        else
             set @formattedSubjects = ""
        endif
        

        /*********************************************************************
        -- Assign Product description on Lead Object in bio for Sales Support
        **********************************************************************/
        
        /* THIS NEEDS TO BE UPDATED TO THE VARIABLE @FORM */

        if @_No_Of_Licences > 1 then
            set @license_pluralisation = IIF(Not Empty(@_No_Of_Licences), 'licenses', 'license') 
            set @Description = Concat('Customer has requested a quote for ', @_No_Of_Licences, " ", @license_pluralisation, ". In relation to campaign: ", @_UTM_Campaign_entry)
        elseif @form == "quote" then
            set @Description = Concat('Customer has requested a quote for ', @_No_Of_Licences, " ", @license_pluralisation, ". In relation to the campaign: ", @_UTM_Campaign_entry)
        elseif @form == "trial" then
            set @Description = Concat('Customer has requested a Trial. In relation to the campaign: ', @_UTM_Campaign_entry)
        elseif @form == "demo" then
            set @Description = Concat('Customer has requested a demo. In relation to the campaign: ', @_UTM_Campaign_entry)
        elseif @form == "info" then
            set @Description = Concat('Customer has requested information. In relation to the campaign: ', @_UTM_Campaign_entry)
        else
            set @Description = Concat('Customer has requested a resource. In relation to the campaign: ', @_UTM_Campaign_entry)
        endif


        /*************************************************************
        -- CREATE SALESFORCE LEAD OBJECT
        **************************************************************/
        set @LeadStatus = "MQL"
        set @LeadSource = "Marketing Cloud"
 

        if @form == 'quote' then 
            set @enquiry = 'Quote' 
        elseif @form == 'trial' then
            set @enquiry = 'Trial' 
        elseif @form == 'demo' then
            set @enquiry = 'Demo'
        elseif @form == 'info' then
            set @enquiry = 'Information'  
        else
            set @enquiry = ''
        endif

        /* Specifying State and Country Variables
        *****************/

        set @countrycode = Lookup("Country_DE","CountryCode","CountryName", @_Country_Name)
        set @rows        = LookupRows("state","State Code", @_State_Name,"Country Code", @countrycode)
        set @rowCount    = rowcount(@rows)

        if @rowCount > 0 then

            for @i = 1 to @rowCount do
                var @stateName
                set @row = row(@rows, @i) /* get row based on counter */
                set @stateName = field(@row,"State Name")
            next @i 
        endif

        /* Update Lead
        *****************/
        set @UpdateStatus = 0
        if not empty(@LeadID) and Substring(@LeadID,1,3) == '00Q' then
          set @UpdateStatus = UpdateSingleSalesforceObject("Lead", @LeadID,
                "FirstName", IIF(Not Empty(@_First_Name), @_First_Name, ""),  
                "LastName", IIF(Not Empty(@_Last_Name), @_Last_Name, ""),               
                "Phone", IIF(Not Empty(@_Phone_Number), @_Phone_Number, 0000000000),  
                "Grade_Level__c", IIF(Not Empty(@_Grade_Level), @_Grade_Level, "Not Mentioned"),  
                "Title", IIF(Not Empty(@_Job_Title), @_Job_Title, 'Unknown'),  
                "Country", IIF(Not Empty(@_Country_Name), @_Country_Name, "Australia"),  
                "State__c", IIF(Not Empty(@stateName),@stateName, ""),   
                "State", IIF(Not Empty(@stateName),@stateName, ""),   
                "PostalCode", IIF(Not Empty(@_Postal_Code), @_Postal_Code, "0000"), 
                "Company", IIF(Not Empty(@_School_Name), @_School_Name, "NA Currently"),
                "No_of_licences__c",  IIF(Not Empty(@_No_Of_Licences), @_No_Of_Licences, 0),           
                "LeadSource", @LeadSource,
                "Status", @LeadStatus,
                "Enquiry_Type__c", @enquiry,
                'GCLID__c', IIF(Not Empty(@gclid), @gclid, 'Unknown')
            )
        endif
                        
        
        
         set @CampaignMemId      = RequestParameter("CampaignMemId")
                   
         /* Update Campaign Member
        *****************/
        set @UpdateCmStatus = ''
        if not empty(@CampaignMemId) and Substring(@CampaignMemId,1,3) == '00v' then
          set @UpdateCmStatus = UpdateSingleSalesforceObject("CampaignMember", @CampaignMemId,"Status","Responded")
        endif

      /*************************************************************
      -- REDIRECT TO PAGE
      **************************************************************/


        /* DEFAULTS
        *****************/

          set @redirectURL_tof = Lookup('TOF-URLRedirect','URL','Id',@RedirectId)
          set @redirectURL_bof = Lookup('BOF_URL_Redirect','URL','Id',@RedirectId)
          set @redirectURL_info = Lookup('INFO_URL_Redirect','URL','Id',@RedirectId)
          
          if @RedirectId > 0 AND indexOf(@form, "tof") then
              set @RedirectURL= @redirectURL_tof
          elseif @RedirectId > 0 AND indexOf(@form, "info") then
              set @RedirectURL= @redirectURL_info 
          else
              set @RedirectURL= @redirectURL_bof
          endif
          
    try {
          set @LogTime = SystemDateToLocalDate(now())
          UpdateData("Forms_Log_2_StageLP",1,
          "GUID",@GUID,
          "LeadId",@LeadID,
          "FirstName",@_First_Name,
          "LastName",@_Last_Name,
          "PhoneNumber",@_Phone_Number,
          "GradeLevel",@_Grade_Level,
          "JobTitle",@_Job_Title,
          "Country",@_Country_Name,
          "CountryCode",@countrycode,
          "State",@stateName,
          "PostalCode",@_Postal_Code,
          "SchoolName",@_School_Name,
          "NoOfLicences",@_No_Of_Licences,
          "PID",@pid,
          "CID",@cid,
          "CampaignName",@_UTM_Campaign_entry,
          "Enquiry_Type",@enquiry,
          "Lead_Status",@LeadStatus,
          "RedirectId",@RedirectId,
          "LeadCreatedorUpdated","Updated",
          "LogTime",@LogTime,
          "http_referrer",@http_referrer,
          "RedirectURL",@RedirectURL)
        } catch {

          SET @errorMessage = "An error occurred while processing your request."
          }
          if @RedirectId > 0 AND indexOf(@form, "tof") then
              Redirect(@redirectURL_tof)
          elseif @RedirectId > 0 AND indexOf(@form, "info") then
              Redirect(@redirectURL_info) 
          else
              Redirect(@redirectURL_bof)
          endif
        /* ACTION
        *****************/
        
          if (@_Debug != true) then
            Redirect(@REDIRECT__Page_URL)
          endif


]%%

