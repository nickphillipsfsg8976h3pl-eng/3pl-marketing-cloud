<script runat="server">
Platform.Load("core", "1.1.1");

// Get query params
var qParam = Request.GetQueryStringParameter("q") || "";
var cParam = Request.GetQueryStringParameter("country") || "";
var sParam = Request.GetQueryStringParameter("state") || "";

// Clean inputs
var query = qParam.toLowerCase();
var country = cParam.toUpperCase();
var state = sParam.toUpperCase();

// Remove leading/trailing whitespace using regex
query = query.replace(/^(\s)+|(\s)+$/g, "");
country = country.replace(/^(\s)+|(\s)+$/g, "");
state = state.replace(/^(\s)+|(\s)+$/g, "");


// Result array and config
var result = [];
var seen = {};
var maxResults = 15;

try {
  var de = DataExtension.Init("School_Lookup_DE");
  var rows = de.Rows.Lookup("Active", "True");

  for (var i = 0; i < rows.length; i++) {
    if (result.length >= maxResults) break;

    var row = rows[i];
    var name = row["School Name"] || "";
    var c = row["Country Code"] || "";
    var s = row["State Code"] || "";
    var active = row["Active"];

    var matchesQuery = !query || name.toLowerCase().indexOf(query) !== -1;
    var matchesCountry = !country || c === country;
    var matchesState = !state || s === state;
    var isActive = (active === true || active === "True" || active === "true");

    if (!name || seen[name]) continue;

    if (matchesQuery && matchesCountry && matchesState && isActive) {
      var label = name;
      if (s) label += " â€“ " + s;
      if (c) label += ", " + c;

      result.push({ label: label, value: name });
      seen[name] = true;
    }
  }

  Platform.Response.SetResponseHeader("Content-Type", "application/json");
  Write(Stringify(result));

} catch (e) {
  Platform.Response.SetResponseHeader("Content-Type", "application/json");
  Write(Stringify({ error: e.message }));
}
</script>
