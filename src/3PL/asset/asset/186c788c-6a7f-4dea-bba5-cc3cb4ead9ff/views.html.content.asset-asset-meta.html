


<!-- 
/******************************
----- GLOBAL FORM SCRIPT ------
*******************************/
-->




%%[/*
=====================================================================================

Todo:

- replace & pass through cid/rid/eid/pid 
as campaign_name, redirect_page, enquiry_type, product_name

-add in 'debug' request parameter to cancel actions and show debug info

-add in a automatic create data extension function (if exists dont create)

LOGIC
======
1. if lead and contact exist
-> update contact
2. if lead exists and no contact
-> update lead
3. otherwise if none exist
-> create a lead 


=====================================================================================
*/]%%








%%[ 

        /*************************************************************
        -- GET REQUEST PARAMETERS
        **************************************************************/


        /* HIDDEN FIELDS
        *****************/

        set @_Debug             = RequestParameter("debug")

        set @form               = lowercase(RequestParameter('form')) 
        Set @_Campaign_Name     = RequestParameter("campaign-name")
        Set @_Triggered_Send_Key= RequestParameter("triggered-send-key")
        Set @_Redirect_To_Page  = RequestParameter("redirect-to-page")
        set @RedirectId         = RequestParameter('rid') 
        set @pid                = RequestParameter('pid') 
        set @cid                = RequestParameter('cid') 
        set @_UTM_Campaign      = RequestParameter("utm-campaign")
        set @_UTM_Content       = RequestParameter("utm-content")
        set @_UTM_Medium        = RequestParameter("utm-medium")
        set @_UTM_Source        = RequestParameter("utm-source")
        set @_UTM_Term          = RequestParameter("utm-term")
        set @gclid              = RequestParameter("gclid")
            set @fbclid             = RequestParameter("fbclid")
    set @msclkid            = RequestParameter("msclkid")
        set @referrer           = RequestParameter("referrer")
        set @http_referrer      = HTTPRequestHeader("referer")


        set @_UTM_Campaign_entry = IIF(Not Empty(@_UTM_Campaign), @_UTM_Campaign, "NA")
        
        if Empty(@_UTM_Campaign) then
            if not Empty(@_Campaign_Name) then
                set @campaignNameLookup = Lookup("ENT.Campaign_Salesforce", "Name", "Id",@_Campaign_Name)
                if not Empty(@campaignNameLookup) then
                    set @_UTM_Campaign_entry = @campaignNameLookup
                endif
            endif
        endif

        /* FORM FIELDS
        *****************/

        set @_Product_Interest    = RequestParameter("product-interest")
        set @_First_Name          = RequestParameter("first-name")
        set @_Last_Name           = RequestParameter("last-name")
        set @_Email_Address       = RequestParameter("email-address")
        set @_Phone_Number        = RequestParameter("phone-number")
        set @_Grade_Level         = RequestParameter("grade-level")
        set @_Job_Title           = RequestParameter("job_title_select")
        set @_Country_Name        = RequestParameter("country-name")
        set @_State_Name          = RequestParameter("state-name")
        set @_Postal_Code         = RequestParameter("postal-code")
        set @_School_Name         = RequestParameter("school-name")
        set @_No_Of_Licences      = RequestParameter("no-of-licences")
        set @_Terms_And_Conditions= RequestParameter("terms-and-conditions")
        set @_Subscriber_Opt_In   = RequestParameter("subscriber-opt-in")
        set @_Subject             = RequestParameter("subject_select")
        set @formattedSubjects    = ""

        if not Empty(@_Subject) then
             set @formattedSubjects = Concat(Replace(@_Subject, ",", ";"), ";")
        else
             set @formattedSubjects = ""
        endif
        

        /*********************************************************************
        -- Assign Product description on Lead Object in bio for Sales Support
        **********************************************************************/
        
        /* THIS NEEDS TO BE UPDATED TO THE VARIABLE @FORM */

        if @_No_Of_Licences > 1 then
            set @license_pluralisation = IIF(Not Empty(@_No_Of_Licences), 'licenses', 'license') 
            set @Description = Concat('Customer has requested a quote for ', @_No_Of_Licences, " ", @license_pluralisation, ". In relation to campaign: ", @_UTM_Campaign_entry)
        elseif @form == "quote" then
            set @Description = Concat('Customer has requested a quote for ', @_No_Of_Licences, " ", @license_pluralisation, ". In relation to the campaign: ", @_UTM_Campaign_entry)
        elseif @form == "trial" then
            set @Description = Concat('Customer has requested a Trial. In relation to the campaign: ', @_UTM_Campaign_entry)
        elseif @form == "demo" then
            set @Description = Concat('Customer has requested a demo. In relation to the campaign: ', @_UTM_Campaign_entry)
        elseif @form == "info" then
            set @Description = Concat('Customer has requested information. In relation to the campaign: ', @_UTM_Campaign_entry)
        else
            set @Description = Concat('Customer has requested a resource. In relation to the campaign: ', @_UTM_Campaign_entry)
        endif


        /*************************************************************
        -- CREATE SALESFORCE LEAD OBJECT
        **************************************************************/
        if @form == 'tof' then
            set @LeadStatus = "Marketing Prospect"
        else
            set @LeadStatus = "MQL"
        endif
 
        set @LeadSource = "Marketing Cloud"

        if @form == 'quote' then 
            set @enquiry = 'Quote' 
        elseif @form == 'trial' then
            set @enquiry = 'Trial' 
        elseif @form == 'demo' then
            set @enquiry = 'Demo'
        elseif @form == 'info' then
            set @enquiry = 'Information'  
        else
            set @enquiry = ''
        endif

        /* Specifying State and Country Variables
        *****************/

        set @countrycode = Lookup("Country_DE","CountryCode","CountryName", @_Country_Name)
        set @rows        = LookupRows("state","State Code", @_State_Name,"Country Code", @countrycode)
        set @rowCount    = rowcount(@rows)

        if @rowCount > 0 then

            for @i = 1 to @rowCount do
                var @stateName
                set @row = row(@rows, @i) /* get row based on counter */
                set @stateName = field(@row,"State Name")
            next @i 
        endif

        /* Create Lead
        *****************/
        set @LEAD__New_Id = CreateSalesforceObject("Lead", 26,
             
              "Marketing_Product_Interest__c", IIF(Not Empty(@_Product_Interest), Replace(@_Product_Interest,",",";"),@pid), 
              "FirstName", IIF(Not Empty(@_First_Name), @_First_Name, ""),  
              "LastName", IIF(Not Empty(@_Last_Name), @_Last_Name, ""),  
              "Email", IIF(Not Empty(@_Email_Address), @_Email_Address, "xxxx@xxxx.com"), 
              "Phone", IIF(Not Empty(@_Phone_Number), @_Phone_Number, 0000000000),  
              "Grade_Level__c", IIF(Not Empty(@_Grade_Level), @_Grade_Level, "Not Mentioned"),  
              "Title", IIF(Not Empty(@_Job_Title), @_Job_Title, 'Unknown'),  
              "Country", IIF(Not Empty(@_Country_Name), @_Country_Name, "Australia"),  
              "State__c", IIF(Not Empty(@stateName),@stateName, ""),   
              "State", IIF(Not Empty(@stateName),@stateName, ""),   
              "PostalCode", IIF(Not Empty(@_Postal_Code), @_Postal_Code, "0000"), 
              "Company", IIF(Not Empty(@_School_Name), @_School_Name, "NA Currently"),
              "No_of_licences__c",  IIF(Not Empty(@_No_Of_Licences), @_No_Of_Licences, 0), 
              "Marketing_Interest__c", IIF(@_Subscriber_Opt_In, "Promotions;Product Information;Newsletter", "Promotions;Product Information;"),
              "LeadSource", @LeadSource,
              "Status", @LeadStatus,
              "Enquiry_Type__c", @enquiry,
              'UTM_Source__c', IIF(Not Empty(@_UTM_Source), @_UTM_Source, @referrer),
              'UTM_Medium__c', IIF(Not Empty(@_UTM_Medium), @_UTM_Medium, 'Unknown'),
              'UTM_Campaign__c', IIF(Not Empty(@_UTM_Campaign), @_UTM_Campaign, 'Organic'),
              'UTM_Content__c', IIF(Not Empty(@_UTM_Content), @_UTM_Content, 'Unknown'),
              'UTM_Term__c', IIF(Not Empty(@_UTM_Term), @_UTM_Term, 'Unknown'),
              'Description', IIF(Not Empty(@Description), @Description, 'Unknown'),
              'GCLID__c', IIF(Not Empty(@gclid), @gclid, 'Unknown'),
              'Subject__c', IIF(Not Empty(@formattedSubjects), @formattedSubjects, ''),
              'Product_Interest__c', IIF(Not Empty(@pid), @pid, Replace(@_Product_Interest,",",";")) 

          )
                        
        /* DEFAULTS
        *************/



        /*************************************************************
        -- CREATE SALESFORCE CAMPAIGN MEMBER OBJECT
        **************************************************************/


        /* DEFAULTS
        *************/

        set @CAMPAIGN_MEMBER__Campaign_Name = IIF(Not Empty(@_Campaign_Name), @_Campaign_Name, '')
        set @CAMPAIGN_MEMBER__Status        = 'Sent'
        set @CAMPAIGN_MEMBER__Lead_Id       = @LEAD__New_Id


        /* ACTION
        ************/

        if ((Not Empty(@CAMPAIGN_MEMBER__Campaign_Name)) AND (Not Empty(@CAMPAIGN_MEMBER__Lead_Id))) then
            set @_Campaign_Objects = RetrieveSalesforceObjects("Campaign", "Id", "Id", "=", @CAMPAIGN_MEMBER__Campaign_Name)            
            if (RowCount(@_Campaign_Objects)>0) then            
                set @CAMPAIGN_MEMBER__CampaignId = Field(Row(@_Campaign_Objects, 1), "Id")
                set @CAMPAIGN_MEMBER__New_Id     = CreateSalesforceObject("CampaignMember", 2,
                                                      "CampaignId", @CAMPAIGN_MEMBER__CampaignId,
                                                      "LeadId", @CAMPAIGN_MEMBER__Lead_Id
                                                  )                        
            endif
        endif




        /*************************************************************
        -- CREATE MARKETING CLOUD TRIGGERED SEND 
        **************************************************************/


        /* DEFAULTS
        *****************/

        set @TRIGGERED_SEND__Customer_Key   = IIF(Not Empty(@_Triggered_Send_Key), @_Triggered_Send_Key, '') 
        set @TRIGGERED_SEND__Email_Address  = IIF(Not Empty(@_Email_Address), @_Email_Address, '') 
        set @TRIGGERED_SEND__Subscriber_Key = IIF(Not Empty(@LEAD__New_Id), @LEAD__New_Id, '') 
        set @FName                          = IIF(Not Empty(@_First_Name), @_First_Name, "")
        set @License                        = IIF(Not Empty(@_No_Of_Licences), @_No_Of_Licences, "")
        set @cidType                        = IIF(Not Empty(@_Campaign_Name), @_Campaign_Name, "")
        set @pidType                        = IIF(Not Empty(@pid), @pid, "")


        /* ACTION
        *****************/

        if ((Not Empty(@TRIGGERED_SEND__Customer_Key)) AND (Not Empty(@TRIGGERED_SEND__Email_Address)) AND (Not Empty(@TRIGGERED_SEND__Subscriber_Key))) then

            set @Triggered_Send_Definition_Object = CreateObject("TriggeredSendDefinition")
            SetObjectProperty(@Triggered_Send_Definition_Object, "CustomerKey", @TRIGGERED_SEND__Customer_Key)

            set @Triggered_Send_Object = CreateObject("TriggeredSend")
            SetObjectProperty(@Triggered_Send_Object, "TriggeredSendDefinition", @Triggered_Send_Definition_Object)

            set @Subscriber_Object = CreateObject("Subscriber")
            SetObjectProperty(@Subscriber_Object, "EmailAddress", @TRIGGERED_SEND__Email_Address)
            SetObjectProperty(@Subscriber_Object, "SubscriberKey", @TRIGGERED_SEND__Subscriber_Key)


            AddObjectArrayItem(@Triggered_Send_Object, "Subscribers", @Subscriber_Object)

            var @Status_Message, @Error_Code
            set @TRIGGERED_SEND__Status_Code = InvokeCreate(@Triggered_Send_Object, @Status_Message, @Error_Code)

        EndIf



      /*************************************************************
      -- REDIRECT TO PAGE
      **************************************************************/


        /* DEFAULTS
        *****************/

          set @redirectURL_tof = Lookup('TOF-URLRedirect','URL','Id',@RedirectId)
          set @redirectURL_bof = Lookup('BOF_URL_Redirect','URL','Id',@RedirectId)
          set @redirectURL_info = Lookup('INFO_URL_Redirect','URL','Id',@RedirectId)
          
          if @RedirectId > 0 AND indexOf(@form, "tof") then
              set @RedirectURL= @redirectURL_tof
          elseif @RedirectId > 0 AND indexOf(@form, "info") then
              set @RedirectURL= @redirectURL_info 
          else
              set @RedirectURL= @redirectURL_bof
          endif
          
    try {
          set @LogTime = SystemDateToLocalDate(now())
          InsertData("Forms_Log",
          "LeadId",@LEAD__New_Id,
          "FirstName",@_First_Name,
          "LastName",@_Last_Name,
          "Email",@_Email_Address,
          "PhoneNumber",@_Phone_Number,
          "GradeLevel",@_Grade_Level,
          "JobTitle",@_Job_Title,
          "Country",@_Country_Name,
          "CountryCode",@countrycode,
          "State",@stateName,
          "PostalCode",@_Postal_Code,
          "SchoolName",@_School_Name,
          "NoOfLicences",@_No_Of_Licences,
          "TermsAndConditions",@_Terms_And_Conditions,
          "OptIn",@_Subscriber_Opt_In,
          "PID",@pid,
          "CID",@cid,
          "CampaignName",@_UTM_Campaign_entry,
          "Product_Interest",@_Product_Interest,
          "Marketing_Product_Interest",@pid,
          "Enquiry_Type",@enquiry,
          "Lead_Status",@LeadStatus,
          "Form",@form,
          "GCLID",@gclid,
           "UTM_Campaign",@_UTM_Campaign,
          "UTM_Content",@_UTM_Content,
          "UTM_Medium",@_UTM_Medium,
          "UTM_Source",@_UTM_Source,
          "UTM_Term",@_UTM_Term,
          "RedirectId",@RedirectId,
          "CampaignMemberID",@CAMPAIGN_MEMBER__New_Id,
          "LeadCreatedorUpdated","Created",
          "LogTime",@LogTime,
          "http_referrer",@http_referrer,
          "RedirectURL",@RedirectURL)
        } catch {

          SET @errorMessage = "An error occurred while processing your request."
          }
          if @RedirectId > 0 AND indexOf(@form, "tof") then
              Redirect(@redirectURL_tof)
          elseif @RedirectId > 0 AND indexOf(@form, "info") then
              Redirect(@redirectURL_info) 
          else
              Redirect(@redirectURL_bof)
          endif
        /* ACTION
        *****************/
        
          if (@_Debug != true) then
            Redirect(@REDIRECT__Page_URL)
          endif


]%%



<!-- ============================================================================================= -->


<h3>
  DEBUG INFO
</h3>

<br/><u>HIDDEN FIELDS</u>

<br>

<br/>_Debug == %%=v(@_Debug)=%%

<br/>

<br/>_Campaign_Name == %%=v(@_Campaign_Name)=%%
<br/>_Triggered_Send_Key == %%=v(@_Triggered_Send_Key)=%%
<br/>_Redirect_To_Page == %%=v(@_Redirect_To_Page)=%%

<br/>

<br/>_UTM_Campaign == %%=v(@_UTM_Campaign)=%%
<br/>_UTM_Content == %%=v(@_UTM_Content)=%%
<br/>_UTM_Medium == %%=v(@_UTM_Medium)=%%
<br/>_UTM_Medium == %%=v(@_UTM_Medium)=%%
<br/>_UTM_Source == %%=v(@_UTM_Source)=%%

<br/>pid == %%=v(@pidType)=%%
<br/>cid == %%=v(@cidType)=%%
<br/>licences == %%=v(@_No_Of_Licences)=%%
<br/>FName == %%=v(@_First_Name)=%%

<br/>

<br/><u>FORM FIELDS</u>

<br/>

<br/>_Product_Interest = %%=v(@_Product_Interest)=%%
<br/>_First_Name = %%=v(@_First_Name)=%%
<br/>_Last_Name = %%=v(@_Last_Name)=%%
<br/>_Email_Address = %%=v(@_Email_Address)=%%
<br/>_Phone_Number = %%=v(@_Phone_Number)=%%
<br/>_Grade_Level = %%=v(@_Grade_Level)=%%
<br/>_Job_Title = %%=v(@_Job_Title)=%%
<br/>_Country_Name = %%=v(@_Country_Name)=%%
<br/>_Country_Code = %%=v(@countrycode)=%%
<br/>_State_Name_Code = %%=v(@_State_Name)=%%
<br/>_state_FullName = %%=v(@stateName)=%%
<br/>_Postal_Code = %%=v(@_Postal_Code)=%%
<br/>_School_Name = %%=v(@_School_Name)=%%
<br/>_No_Of_Licences = %%=v(@_No_Of_Licences)=%%
<br/>_Terms_And_Conditions = %%=v(@_Terms_And_Conditions)=%%
<br/>_Subscriber_Opt_In = %%=v(@_Subscriber_Opt_In)=%%

<br/>

<br/><u>AMPSCRIPT VARIABLES</u>

<br/>

<br/>LEAD__New_Id == %%=v(@LEAD__New_Id)=%%

<br>

<br/>TRIGGERED_SEND__Subscriber_Key == %%=v(@TRIGGERED_SEND__Subscriber_Key)=%%
<br/>TRIGGERED_SEND__Email_Address == %%=v(@TRIGGERED_SEND__Email_Address)=%%
<br/>TRIGGERED_SEND__CustomerKey == %%=v(@TRIGGERED_SEND__Customer_Key)=%%
<br/>TRIGGERED_SEND__Status_Code == %%=v(@TRIGGERED_SEND__Status_Code)=%%

<br>

<br/>CAMPAIGN_MEMBER__Campaign_Name == %%=v(@CAMPAIGN_MEMBER__Campaign_Name)=%%
<br/>CAMPAIGN_MEMBER__CampaignId == %%=v(@CAMPAIGN_MEMBER__CampaignId)=%%
<br/>CAMPAIGN_MEMBER__New_Id == %%=v(@CAMPAIGN_MEMBER__New_Id)=%%
<br/>enquiry == %%=v(@enquiry)=%%
<br/>LeadStatus == %%=v(@LeadStatus)=%%

<br>

<br/>REDIRECT__Page_URL == %%=v(@REDIRECT__Page_URL)=%%